services:
- mysql:5.7

variables:
  MYSQL_ROOT_PASSWORD: shopware
  MYSQL_ROOT_HOST: '%'
  MYSQL_DATABASE: shopware
  MYSQL_USER: shopware
  MYSQL_PASSWORD: shopware

build:
  image: "kellerkinder/symfony3:1.0.2"
  stage: build
  when: manual
  script:
  - curl -sS https://getcomposer.org/installer | php && php composer.phar -q -n --prefer-dist install
  - ./vendor/bin/php-cs-fixer fix -v --dry-run --using-cache=no

test:
  image: "kellerkinder/shopware-testing:php71-1.0.0"
  stage: test
  script:
  - apt update && apt install curl software-properties-common -y
  - curl -sL https://deb.nodesource.com/setup_8.x | bash -
  - apt install nodejs -y
  - wget https://raw.githubusercontent.com/composer/getcomposer.org/1b137f8bf6db3e79a38a5bc45324414a6b1f9df2/web/installer -O - -q | php -- --quiet --install-dir=/usr/bin --filename=composer
  - git clone https://github.com/shopware/development "${CI_PROJECT_DIR}/opt/shopware"
  - mv ${CI_PROJECT_DIR}/opt /tmp/opt
  - cp -r ${CI_PROJECT_DIR} /tmp/opt/shopware/custom/plugins/${CI_PROJECT_NAME}
  - mv /tmp/opt ${CI_PROJECT_DIR}/opt
  - 'printf "const:\n    APP_ENV: \"dev\"\n    APP_URL: \"http://localhost\"\n    DB_HOST: \"mysql\"\n    DB_PORT: \"3306\"\n    DB_NAME: \"${MYSQL_DATABASE}\"\n    DB_USER: \"root\"\n    DB_PASSWORD: \"${MYSQL_ROOT_PASSWORD}\"" > "${CI_PROJECT_DIR}/opt/shopware/.psh.yaml.override"'
  - cd ${CI_PROJECT_DIR}/opt/shopware && php ${CI_PROJECT_DIR}/opt/shopware/psh.phar install
  - php ${CI_PROJECT_DIR}/opt/shopware/bin/console plugin:update
  - php ${CI_PROJECT_DIR}/opt/shopware/bin/console plugin:install --activate ${CI_PROJECT_NAME}
  - cd ${CI_PROJECT_DIR}/opt/shopware/custom/plugins/${CI_PROJECT_NAME} && ${CI_PROJECT_DIR}/opt/shopware/vendor/bin/phpunit
