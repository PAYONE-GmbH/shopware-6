{% sw_extends '@Storefront/base.html.twig' %}

{% block base_body_script %}
    {{ parent() }}

    {% if page.extensions.payone %}
        <script type='text/javascript' src='https://secure.pay1.de/client-api/js/v1/payone_hosted_min.js'></script>

        {% set select_style %}
            width: 100%;
            height: calc(1.5em + 1.45rem);
            padding: .5625rem;
            color: #8798a9;
            vertical-align: middle;
            line-height: 1.5;
            font-weight: 500;
            background-color: #fff;
            border: .0625rem solid #d1d9e0;
            border-radius: 3px;
        {% endset %}

        {% set field_style %}
            width: 100%;
            height: 100%;
            padding: .5625rem;
            color: #8798a9;
            vertical-align: middle;
            line-height: 1.5;
            font-weight: 500;
            background-color: #fff;
            border: .0625rem solid #d1d9e0;
            border-radius: .1875rem;
        {% endset %}

        <script>
            let orderFormDisabled = true;

            $(document).ready(function () {
                let request = {{ page.extensions.payone.cardRequest | json_encode | raw }};

                let config = {
                    fields: {
                        cardpan: {
                            selector: 'cardpan',                 // put name of your div-container here
                            type: 'text',
                            style: {{ field_style | json_encode | raw }}
                        },
                        cardcvc2: {
                            selector: 'cardcvc2',                // put name of your div-container here
                            type: 'password',                    // select(default), text, password, tel
                            size: '4',
                            maxlength: '4',
                            style: {{ field_style | json_encode | raw }}
                        },
                        cardexpiremonth: {
                            selector: 'cardexpiremonth',         // put name of your div-container here
                            type: 'select',                      // select(default), text, password, tel
                            size: '2',
                            maxlength: '2',
                            style: {{ select_style | json_encode | raw }}
                        },
                        cardexpireyear: {
                            selector: 'cardexpireyear',          // put name of your div-container here
                            type: 'select',
                            style: {{ select_style | json_encode | raw }}
                        }
                    },

                    defaultStyle: {
                        iframe: {
                            height: '100%',
                            width: '100%'
                        }
                    },

                    language: Payone.ClientApi.Language[{{ page.extensions.payone.language | json_encode | raw }}],

                    autoCardtypeDetection: {
                        supportedCardtypes: ['#', 'V', 'A', 'M', 'D', 'J', 'O', 'U', 'P'],

                        callback: function (detectedCardtype) {
                            if (detectedCardtype === "-" || detectedCardtype === "?") {
                                return;
                            }

                            let src = 'https://cdn.pay1.de/cc/' + detectedCardtype.toLowerCase() + '/xl/default.png';

                            $('#card-logo').attr('src', src).show();
                            $("#errorOutput").hide();
                        }
                    },
                };

                const iframes = new Payone.ClientApi.HostedIFrames(config, request);

                $('#confirmOrderForm').submit(function () {
                    $("#errorOutput").hide();

                    iframes.creditCardCheck('payoneCheckCallback');

                    if (!iframes.isComplete() || orderFormDisabled) {
                        return false;
                    }
                });
            });

            function payoneCheckCallback(response) {
                if (response.status === 'VALID') {
                    document.getElementById('pseudocardpan').value = response.pseudocardpan;
                    document.getElementById('truncatedcardpan').value = response.truncatedcardpan;

                    orderFormDisabled = false;

                    $('#confirmOrderForm').submit();
                } else {
                    let button = $("#confirmFormSubmit");

                    button.removeAttr('disabled');
                    button.find(".spinner-border").remove();

                    $("#errorOutput")
                        .html(response.errormessage)
                        .show();
                }
            }
        </script>

        <style type="text/css">
            .payone-payment .form-control {
                padding: 0;
                border: 0;
            }

            .payone-payment .card-logo-container {
                padding-left: 10px;
            }

            .payone-payment #card-logo {
                display: block;
                height: calc(1.5em + 1.25rem);
                border: 1px solid transparent;
                margin: 0 auto;
            }

            .payone-payment .alert {
                margin: 0;
            }
        </style>
    {% endif %}
{% endblock %}
