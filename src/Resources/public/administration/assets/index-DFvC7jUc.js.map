{"version":3,"file":"index-DFvC7jUc.js","sources":["../../../app/administration/src/module/sw-order/component/payone-refund-button/payone-refund-button.html.twig","../../../app/administration/src/module/sw-order/component/payone-refund-button/index.js"],"sourcesContent":["{% block payone_payment_payment_details %}\n    <div class=\"payone-refund-button\">\n        <sw-container\n            v-tooltip=\"{message: $t('sw-order.payone-payment.refund.tooltips.impossible'), disabled: buttonEnabled}\"\n            :key=\"buttonEnabled\"\n        >\n            <mt-button\n                :disabled=\"!buttonEnabled\"\n                @click=\"openRefundModal\"\n                variant=\"secondary\"\n                size=\"default\"\n            >\n                {{ $t('sw-order.payone-payment.refund.buttonTitle') }}\n            </mt-button>\n        </sw-container>\n\n        <sw-modal\n            v-if=\"showRefundModal\"\n            @modal-close=\"closeRefundModal\"\n            :title=\"$t(`sw-order.payone-payment.modal.refund.title`)\"\n            class=\"payone-payment-detail--refund-modal\"\n        >\n            <payone-order-items\n                :order=\"order\"\n                :items=\"items\"\n            ></payone-order-items>\n\n            <div class=\"payone-payment-detail--refund-modal--content\">\n                <sw-container\n                    columns=\"1fr 1fr\"\n                    gap=\"0 32px\"\n                >\n                    <mt-text-field\n                        :disabled=\"true\"\n                        :label=\"$t('sw-order.payone-payment.modal.orderAmount')\"\n                        :model-value=\"currencyFilter(transaction.amount.totalPrice, order.currency.shortName)\"\n                    ></mt-text-field>\n\n                    <mt-text-field\n                        :disabled=\"true\"\n                        :label=\"$t('sw-order.payone-payment.modal.refund.refunded')\"\n                        :model-value=\"payoneCurrencyFilter(refundedAmount, order.currency.shortName)\"\n                    ></mt-text-field>\n\n                    <mt-text-field\n                        :disabled=\"true\"\n                        :label=\"$t('sw-order.payone-payment.modal.remainingAmount')\"\n                        :model-value=\"payoneCurrencyFilter(remainingAmount, order.currency.shortName)\"\n                    ></mt-text-field>\n\n                    <mt-number-field\n                        required=\"required\"\n                        numberType=\"float\"\n                        :digits=\"decimalPrecision\"\n                        :label=\"$t('sw-order.payone-payment.modal.refund.amount')\"\n                        v-model=\"refundAmount\"\n                        :min=\"0\"\n                        :max=\"remainingAmount\"\n                    ></mt-number-field>\n                </sw-container>\n            </div>\n\n            <template #modal-footer>\n                <mt-button\n                    :disabled=\"isLoading\"\n                    @click=\"closeRefundModal\"\n                    variant=\"secondary\"\n                >\n                    {{ $t('sw-order.payone-payment.modal.close') }}\n                </mt-button>\n\n                <sw-button-process\n                    :isLoading=\"isLoading\"\n                    :processSuccess=\"isRefundSuccessful\"\n                    @process-finish=\"onRefundFinished()\"\n                    :disabled=\"isLoading || refundAmount <= 0\"\n                    variant=\"primary\"\n                    @click=\"refundOrder\"\n                >\n                    {{ $t('sw-order.payone-payment.modal.refund.submit') }}\n                </sw-button-process>\n\n                <sw-button-process\n                    :isLoading=\"isLoading\"\n                    :processSuccess=\"isRefundSuccessful\"\n                    @process-finish=\"onRefundFinished()\"\n                    :disabled=\"isLoading\"\n                    variant=\"primary\"\n                    @click=\"refundFullOrder\"\n                >\n                    {{ $t('sw-order.payone-payment.modal.refund.fullSubmit') }}\n                </sw-button-process>\n            </template>\n        </sw-modal>\n    </div>\n{% endblock %}","import template from './payone-refund-button.html.twig';\nimport './payone-refund-button.scss';\n\nconst {Mixin, Filter} = Shopware;\n\nexport default {\n    template,\n\n    mixins: [\n        Mixin.getByName('notification')\n    ],\n\n    inject: ['PayonePaymentService'],\n\n    props: {\n        order: {\n            type: Object,\n            required: true\n        },\n        transaction: {\n            type: Object,\n            required: true\n        }\n    },\n\n    data() {\n        return {\n            isLoading: false,\n            hasError: false,\n            showRefundModal: false,\n            isRefundSuccessful: false,\n            refundAmount: 0.0,\n            includeShippingCosts: false,\n            items: [],\n        };\n    },\n\n    computed: {\n        currencyFilter() {\n            return Filter.getByName('currency');\n        },\n\n        payoneCurrencyFilter() {\n            return Filter.getByName('payone_currency');\n        },\n\n        orderTotalPrice() {\n            return this.transaction.amount.totalPrice;\n        },\n\n        decimalPrecision() {\n            if (!this.order || !this.order.currency) {\n                return 2;\n            }\n            if (this.order.currency.decimalPrecision) {\n                return this.order.currency.decimalPrecision;\n            }\n            if (this.order.currency.itemRounding) {\n                return this.order.currency.itemRounding.decimals;\n            }\n        },\n\n        transactionData() {\n            return this.transaction?.extensions?.payonePaymentOrderTransactionData ?? {\n                capturedAmount: 0,\n                refundedAmount: 0,\n                allowRefund: false\n            };\n        },\n\n        capturedAmount() {\n            return this.toFixedPrecision((this.transaction?.extensions?.payonePaymentOrderTransactionData?.capturedAmount ?? 0) / 100);\n        },\n\n        remainingAmount() {\n            return (this.transactionData.capturedAmount ?? 0) - (this.transactionData.refundedAmount ?? 0);\n        },\n\n        refundedAmount() {\n            return this.transactionData.refundedAmount ?? 0;\n        },\n\n        buttonEnabled() {\n            if (!this.transaction?.extensions?.payonePaymentOrderTransactionData) {\n                return false;\n            }\n\n            return this.remainingAmount > 0 || this.transactionData.allowRefund;\n        },\n\n        selectedItems() {\n            return this.items.filter(item => item.selected && item.quantity > 0);\n        },\n\n        hasRemainingRefundableShippingCosts() {\n            if (this.order.shippingCosts.totalPrice <= 0) {\n                return false;\n            }\n\n            return this.toFixedPrecision(this.refundedAmount + this.order.shippingCosts.totalPrice) <= this.capturedAmount;\n        }\n    },\n\n    methods: {\n        toFixedPrecision(value) {\n            return Math.round(value * (10 ** this.decimalPrecision)) / (10 ** this.decimalPrecision);\n        },\n\n        calculateActionAmount() {\n            let amount = 0;\n\n            this.selectedItems.forEach((selection) => {\n                amount += selection.unit_price * selection.quantity;\n            });\n\n            this.refundAmount = this.toFixedPrecision(amount > this.remainingAmount ? this.remainingAmount : amount);\n        },\n\n        openRefundModal() {\n            this.showRefundModal = true;\n            this.isRefundSuccessful = false;\n            this.initItems();\n        },\n\n        initItems() {\n            this.items = this.order.lineItems.map((orderItem) => {\n                // note: if the order got captured during the payment (direct authorize instead of pre-authorize), the field `payone_captured_quantity` will be empty.\n                // in this case we are using the ordered quantity\n                const qty = this.getRefundableQuantityOfItem(orderItem);\n\n                return {\n                    id: orderItem.id,\n                    quantity: qty,\n                    maxQuantity: qty,\n                    unit_price: orderItem.unitPrice,\n                    selected: false,\n                    product: orderItem.label,\n                    orderItem: orderItem,\n                    disabled: qty <= 0,\n                };\n            });\n\n            if (this.order.shippingCosts.totalPrice > 0) {\n                this.items.push({\n                    id: 'shipping',\n                    quantity: 1,\n                    maxQuantity: 1,\n                    unit_price: this.order.shippingCosts.totalPrice,\n                    selected: false,\n                    disabled: false,\n                    product: this.$t('sw-order.payone-payment.modal.shippingCosts'),\n                });\n            }\n        },\n\n        closeRefundModal() {\n            this.showRefundModal = false;\n        },\n\n        onRefundFinished() {\n            this.isRefundSuccessful = false;\n        },\n\n        refundOrder() {\n            const request = {\n                orderTransactionId: this.transaction.id,\n                payone_order_id: this.transaction.extensions.payonePaymentOrderTransactionData.transactionId,\n                salesChannel: this.order.salesChannel,\n                amount: this.refundAmount,\n                orderLines: [],\n                complete: this.refundAmount === this.maxRefundAmount,\n                includeShippingCosts: false\n            };\n\n            this.isLoading = true;\n\n            this.selectedItems.forEach((selection) => {\n                if (selection.id === 'shipping') {\n                    request.includeShippingCosts = true;\n                } else {\n                    const orderLineItem = this.order.lineItems.find(lineItem => lineItem.id === selection.id);\n                    if (orderLineItem) {\n                        const copy = {...orderLineItem};\n\n                        copy.quantity = selection.quantity;\n                        copy.total_amount = copy.unit_price * copy.quantity;\n                        copy.total_tax_amount = copy.total_amount - (copy.total_amount / (1 + (copy.tax_rate / 100)));\n\n                        request.orderLines.push(copy);\n                    }\n                }\n            });\n\n            if (this.remainingAmount < request.amount) {\n                request.amount = this.remainingAmount;\n            }\n\n            this.executeRefund(request);\n        },\n\n        getRefundableQuantityOfItem(orderItem) {\n            return (orderItem.customFields?.payone_captured_quantity ?? orderItem.quantity) - (orderItem.customFields?.payone_refunded_quantity ?? 0);\n        },\n\n        refundFullOrder() {\n            const request = {\n                orderTransactionId: this.transaction.id,\n                payone_order_id: this.transaction.extensions.payonePaymentOrderTransactionData.transactionId,\n                salesChannel: this.order.salesChannel,\n                amount: this.maxRefundAmount,\n                orderLines: [],\n                complete: true,\n                includeShippingCosts: this.hasRemainingRefundableShippingCosts\n            };\n\n            this.isLoading = true;\n\n            request.orderLines = this.order.lineItems.map((orderItem) => {\n                return {\n                    id: orderItem.id,\n                    quantity: this.getRefundableQuantityOfItem(orderItem),\n                    unit_price: orderItem.unitPrice,\n                    selected: false\n                };\n            });\n\n            this.executeRefund(request);\n        },\n\n        executeRefund(request) {\n            this.PayonePaymentService.refundPayment(request).then(() => {\n                this.createNotificationSuccess({\n                    title: this.$t('sw-order.payone-payment.refund.successTitle'),\n                    message: this.$t('sw-order.payone-payment.refund.successMessage')\n                });\n\n                this.isRefundSuccessful = true;\n            }).catch((error) => {\n                this.createNotificationError({\n                    title: this.$t('sw-order.payone-payment.refund.errorTitle'),\n                    message: error.message\n                });\n\n                this.isRefundSuccessful = false;\n            }).finally(() => {\n                this.isLoading = false;\n                this.closeRefundModal();\n\n                this.$nextTick().then(() => {\n                    this.$emit('reload')\n                });\n            });\n        },\n    },\n    watch: {\n        items: {\n            handler() {\n                this.calculateActionAmount();\n            },\n            deep: true,\n        }\n    }\n};\n"],"names":["template","Mixin","Filter","index","_a","_b","_c","item","value","amount","selection","orderItem","qty","request","orderLineItem","lineItem","copy","error"],"mappings":"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"}