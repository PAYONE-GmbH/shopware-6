const a=`{% block payone_payment_payment_details %} <div class="payone-refund-button"> <sw-container v-tooltip="{message: $t('sw-order.payone-payment.refund.tooltips.impossible'), disabled: buttonEnabled}" :key="buttonEnabled" > <mt-button :disabled="!buttonEnabled" @click="openRefundModal" variant="secondary" size="default" > {{ $t('sw-order.payone-payment.refund.buttonTitle') }} </mt-button> </sw-container> <sw-modal v-if="showRefundModal" @modal-close="closeRefundModal" :title="$t(\`sw-order.payone-payment.modal.refund.title\`)" class="payone-payment-detail--refund-modal" > <payone-order-items :order="order" :items="items" ></payone-order-items> <div class="payone-payment-detail--refund-modal--content"> <sw-container columns="1fr 1fr" gap="0 32px" > <mt-text-field :disabled="true" :label="$t('sw-order.payone-payment.modal.orderAmount')" :model-value="currencyFilter(transaction.amount.totalPrice, order.currency.shortName)" ></mt-text-field> <mt-text-field :disabled="true" :label="$t('sw-order.payone-payment.modal.refund.refunded')" :model-value="payoneCurrencyFilter(refundedAmount, order.currency.shortName)" ></mt-text-field> <mt-text-field :disabled="true" :label="$t('sw-order.payone-payment.modal.remainingAmount')" :model-value="payoneCurrencyFilter(remainingAmount, order.currency.shortName)" ></mt-text-field> <mt-number-field required="required" numberType="float" :digits="decimalPrecision" :label="$t('sw-order.payone-payment.modal.refund.amount')" v-model="refundAmount" :min="0" :max="remainingAmount" ></mt-number-field> </sw-container> </div> <template #modal-footer> <mt-button :disabled="isLoading" @click="closeRefundModal" variant="secondary" > {{ $t('sw-order.payone-payment.modal.close') }} </mt-button> <sw-button-process :isLoading="isLoading" :processSuccess="isRefundSuccessful" @process-finish="onRefundFinished()" :disabled="isLoading || refundAmount <= 0" variant="primary" @click="refundOrder" > {{ $t('sw-order.payone-payment.modal.refund.submit') }} </sw-button-process> <sw-button-process :isLoading="isLoading" :processSuccess="isRefundSuccessful" @process-finish="onRefundFinished()" :disabled="isLoading" variant="primary" @click="refundFullOrder" > {{ $t('sw-order.payone-payment.modal.refund.fullSubmit') }} </sw-button-process> </template> </sw-modal> </div> {% endblock %}`,{Mixin:r,Filter:s}=Shopware,o={template:a,mixins:[r.getByName("notification")],inject:["PayonePaymentService"],props:{order:{type:Object,required:!0},transaction:{type:Object,required:!0}},data(){return{isLoading:!1,hasError:!1,showRefundModal:!1,isRefundSuccessful:!1,refundAmount:0,includeShippingCosts:!1,items:[]}},computed:{currencyFilter(){return s.getByName("currency")},payoneCurrencyFilter(){return s.getByName("payone_currency")},orderTotalPrice(){return this.transaction.amount.totalPrice},decimalPrecision(){if(!this.order||!this.order.currency)return 2;if(this.order.currency.decimalPrecision)return this.order.currency.decimalPrecision;if(this.order.currency.itemRounding)return this.order.currency.itemRounding.decimals},transactionData(){var e,t;return((t=(e=this.transaction)==null?void 0:e.extensions)==null?void 0:t.payonePaymentOrderTransactionData)??{capturedAmount:0,refundedAmount:0,allowRefund:!1}},capturedAmount(){var e,t,i;return this.toFixedPrecision((((i=(t=(e=this.transaction)==null?void 0:e.extensions)==null?void 0:t.payonePaymentOrderTransactionData)==null?void 0:i.capturedAmount)??0)/100)},remainingAmount(){return(this.transactionData.capturedAmount??0)-(this.transactionData.refundedAmount??0)},refundedAmount(){return this.transactionData.refundedAmount??0},buttonEnabled(){var e,t;return(t=(e=this.transaction)==null?void 0:e.extensions)!=null&&t.payonePaymentOrderTransactionData?this.remainingAmount>0||this.transactionData.allowRefund:!1},selectedItems(){return this.items.filter(e=>e.selected&&e.quantity>0)},hasRemainingRefundableShippingCosts(){return this.order.shippingCosts.totalPrice<=0?!1:this.toFixedPrecision(this.refundedAmount+this.order.shippingCosts.totalPrice)<=this.capturedAmount}},methods:{toFixedPrecision(e){return Math.round(e*10**this.decimalPrecision)/10**this.decimalPrecision},calculateActionAmount(){let e=0;this.selectedItems.forEach(t=>{e+=t.unit_price*t.quantity}),this.refundAmount=this.toFixedPrecision(e>this.remainingAmount?this.remainingAmount:e)},openRefundModal(){this.showRefundModal=!0,this.isRefundSuccessful=!1,this.initItems()},initItems(){this.items=this.order.lineItems.map(e=>{const t=this.getRefundableQuantityOfItem(e);return{id:e.id,quantity:t,maxQuantity:t,unit_price:e.unitPrice,selected:!1,product:e.label,orderItem:e,disabled:t<=0}}),this.order.shippingCosts.totalPrice>0&&this.items.push({id:"shipping",quantity:1,maxQuantity:1,unit_price:this.order.shippingCosts.totalPrice,selected:!1,disabled:!1,product:this.$t("sw-order.payone-payment.modal.shippingCosts")})},closeRefundModal(){this.showRefundModal=!1},onRefundFinished(){this.isRefundSuccessful=!1},refundOrder(){const e={orderTransactionId:this.transaction.id,payone_order_id:this.transaction.extensions.payonePaymentOrderTransactionData.transactionId,salesChannel:this.order.salesChannel,amount:this.refundAmount,orderLines:[],complete:this.refundAmount===this.maxRefundAmount,includeShippingCosts:!1};this.isLoading=!0,this.selectedItems.forEach(t=>{if(t.id==="shipping")e.includeShippingCosts=!0;else{const i=this.order.lineItems.find(n=>n.id===t.id);if(i){const n={...i};n.quantity=t.quantity,n.total_amount=n.unit_price*n.quantity,n.total_tax_amount=n.total_amount-n.total_amount/(1+n.tax_rate/100),e.orderLines.push(n)}}}),this.remainingAmount<e.amount&&(e.amount=this.remainingAmount),this.executeRefund(e)},getRefundableQuantityOfItem(e){var t,i;return(((t=e.customFields)==null?void 0:t.payone_captured_quantity)??e.quantity)-(((i=e.customFields)==null?void 0:i.payone_refunded_quantity)??0)},refundFullOrder(){const e={orderTransactionId:this.transaction.id,payone_order_id:this.transaction.extensions.payonePaymentOrderTransactionData.transactionId,salesChannel:this.order.salesChannel,amount:this.maxRefundAmount,orderLines:[],complete:!0,includeShippingCosts:this.hasRemainingRefundableShippingCosts};this.isLoading=!0,e.orderLines=this.order.lineItems.map(t=>({id:t.id,quantity:this.getRefundableQuantityOfItem(t),unit_price:t.unitPrice,selected:!1})),this.executeRefund(e)},executeRefund(e){this.PayonePaymentService.refundPayment(e).then(()=>{this.createNotificationSuccess({title:this.$t("sw-order.payone-payment.refund.successTitle"),message:this.$t("sw-order.payone-payment.refund.successMessage")}),this.isRefundSuccessful=!0}).catch(t=>{this.createNotificationError({title:this.$t("sw-order.payone-payment.refund.errorTitle"),message:t.message}),this.isRefundSuccessful=!1}).finally(()=>{this.isLoading=!1,this.closeRefundModal(),this.$nextTick().then(()=>{this.$emit("reload")})})}},watch:{items:{handler(){this.calculateActionAmount()},deep:!0}}};export{o as default};
//# sourceMappingURL=index-DFvC7jUc.js.map
